import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

# --- CONFIGURA√á√ÉO DA P√ÅGINA ---
st.set_page_config(
    page_title="Rastreador de Royalties - Amaz√¥nia",
    page_icon="üõ¢Ô∏è",
    layout="wide"
)

# --- 1. DADOS SIMULADOS (MOCK DATA) ---
# Na vers√£o final, substituiremos isso por: df = pd.read_excel("seus_dados.xlsx")
data = {
    'municipio': ['Coari', 'Munic√≠pio A (Liminar)', 'Tef√©', 'Munic√≠pio B (Liminar)', 'Codaj√°s'],
    'ranking': [1, 2, 3, 4, 5],
    'grupo': ['ANP', 'Liminar', 'ANP', 'Liminar', 'ANP'],
    'arrecadacao_total': [150000000.00, 85000000.00, 60000000.00, 45000000.00, 30000000.00],
    'tem_portal': ['Sim', 'N√£o', 'Sim', 'Parcial', 'Sim'],
    'maior_beneficiario_tipo': ['Obras/Engenharia', 'Escrit√≥rio de Advocacia', 'Sa√∫de', 'Escrit√≥rio de Advocacia', 'Obras'],
    'pagou_inss_irregular': ['N√£o', 'Sim', 'N√£o', 'Sim', 'N√£o'],
    'perc_educacao': [70, 5, 76, 0, 75],  # Meta √© 75%
    'perc_saude': [20, 5, 25, 0, 26],     # Meta √© 25%
    'analise_texto': [
        "Apresenta alta conformidade. Maior gasto em infraestrutura.",
        "Alto volume para escrit√≥rio jur√≠dico. Ind√≠cios de uso para folha de pagamento.",
        "Segue a lei de partilha. Transpar√™ncia ativa funcional.",
        "Portal fora do ar. Receita usada quase integralmente para custeio da m√°quina.",
        "Bons indicadores de aplica√ß√£o na educa√ß√£o b√°sica."
    ]
}

df = pd.DataFrame(data)

# --- FUN√á√ïES DE VISUALIZA√á√ÉO ---

def plot_compliance(educacao, saude):
    """Gera o gr√°fico de rosca para conformidade legal"""
    outros = 100 - (educacao + saude)
    if outros < 0: outros = 0 # Ajuste simples para erro de dados
    
    labels = ['Educa√ß√£o (Meta 75%)', 'Sa√∫de (Meta 25%)', 'Outros/Irregular']
    values = [educacao, saude, outros]
    colors = ['#2ecc71', '#3498db', '#e74c3c'] # Verde, Azul, Vermelho
    
    fig = go.Figure(data=[go.Pie(labels=labels, values=values, hole=.6, marker=dict(colors=colors))])
    fig.update_layout(showlegend=True, margin=dict(t=0, b=0, l=0, r=0), height=250)
    return fig

# --- INTERFACE PRINCIPAL ---

st.title("üõ¢Ô∏è Rastreador de Royalties: Amaz√¥nia")
st.markdown("""
**Monitoramento do Top Arrecadadores (2021-2025)** Esta ferramenta analisa a destina√ß√£o dos recursos de royalties de petr√≥leo e g√°s, destacando a diferen√ßa entre munic√≠pios produtores (ANP) e benefici√°rios de liminares.
""")

st.divider()

# --- SIDEBAR DE NAVEGA√á√ÉO ---
st.sidebar.header("Navega√ß√£o")
view_option = st.sidebar.radio("Escolha a visualiza√ß√£o:", ["üèÜ Ranking Geral", "üîç Raio-X por Munic√≠pio"])

# --- VIS√ÉO 1: RANKING GERAL ---
if view_option == "üèÜ Ranking Geral":
    st.header("Top Arrecadadores no Amazonas")
    
    # M√©tricas gerais
    col1, col2, col3 = st.columns(3)
    col1.metric("Munic√≠pios Monitorados", len(df))
    col1.info("Foco no Top 5 (Simula√ß√£o)")
    
    total_arrecadado = df['arrecadacao_total'].sum()
    col2.metric("Volume Total Rastreado", f"R$ {total_arrecadado:,.2f}")
    
    liminares = df[df['grupo'] == 'Liminar'].shape[0]
    col3.metric("Munic√≠pios via Liminar", liminares, delta_color="inverse")

    st.markdown("### Comparativo de Receita")
    
    # Gr√°fico de Barras do Ranking
    fig_bar = px.bar(
        df, 
        x='municipio', 
        y='arrecadacao_total',
        color='grupo',
        title='Arrecada√ß√£o Total por Munic√≠pio e Tipo de Recebimento',
        labels={'arrecadacao_total': 'Total Recebido (R$)', 'municipio': 'Munic√≠pio', 'grupo': 'Origem'},
        color_discrete_map={'ANP': '#2ecc71', 'Liminar': '#e74c3c'}
    )
    st.plotly_chart(fig_bar, use_container_width=True)
    
    st.dataframe(
        df[['ranking', 'municipio', 'grupo', 'arrecadacao_total', 'tem_portal']],
        hide_index=True,
        use_container_width=True
    )

# --- VIS√ÉO 2: RAIO-X DETALHADO ---
else:
    st.sidebar.markdown("---")
    cidade_selecionada = st.sidebar.selectbox("Selecione o Munic√≠pio:", df['municipio'])
    
    # Filtrar dados da cidade
    cidade_data = df[df['municipio'] == cidade_selecionada].iloc[0]
    
    # Cabe√ßalho da Cidade
    st.header(f"Raio-X: {cidade_selecionada}")
    
    # Badges de Status
    c1, c2, c3 = st.columns(3)
    if cidade_data['grupo'] == 'Liminar':
        c1.error(f"üìå Grupo: {cidade_data['grupo']}")
    else:
        c1.success(f"üìå Grupo: {cidade_data['grupo']}")
        
    c2.metric("Ranking de Arrecada√ß√£o", f"#{cidade_data['ranking']}")
    c3.metric("Receita Total", f"R$ {cidade_data['arrecadacao_total']:,.2f}")

    st.markdown("---")

    # Colunas de An√°lise
    col_esquerda, col_direita = st.columns([1, 1])

    with col_esquerda:
        st.subheader("‚ö†Ô∏è Conformidade Legal (Lei 12.858/2013)")
        st.caption("Meta: 75% Educa√ß√£o | 25% Sa√∫de")
        
        # Gr√°fico de Donut
        fig_donut = plot_compliance(cidade_data['perc_educacao'], cidade_data['perc_saude'])
        st.plotly_chart(fig_donut, use_container_width=True)
        
        # Alerta de INSS
        if cidade_data['pagou_inss_irregular'] == 'Sim':
            st.error("""
            **üö® ALERTA DE DESVIO:** Identificado pagamento de encargos previdenci√°rios (INSS) com fonte de Royalties. 
            Isso pode configurar desvio de finalidade.
            """)
        else:
            st.success("‚úÖ Sem pagamentos irregulares de INSS detectados nesta amostra.")

    with col_direita:
        st.subheader("üîé Destina√ß√£o e Transpar√™ncia")
        
        st.markdown(f"**Portal da Transpar√™ncia:** {cidade_data['tem_portal']}")
        
        st.info(f"**Maior Benefici√°rio dos Recursos:** \n\n {cidade_data['maior_beneficiario_tipo']}")
        
        st.markdown("### An√°lise Jornal√≠stica")
        st.write(f"> {cidade_data['analise_texto']}")
